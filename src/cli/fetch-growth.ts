#!/usr/bin/env nodeimport yargs from 'yargs';import { hideBin } from 'yargs/helpers';import { GrowthFetcher } from '../fetchers/growthFetcher.js';import { ErrorHandler } from '../utils/errorHandler.js';import { setupCliSignalHandler } from '../utils/signalHandler.js';import { processStocks } from '../utils/batchProcessor.js';import ora from 'ora';import { DEFAULT_STOCK_CODES } from '../constants/stocks.js';const argv = yargs(hideBin(process.argv))  .option('stocks', {    alias: 's',    type: 'string',    description: 'Comma-separated stock codes (e.g., 2330,2454)',  })  .option('no-cache', {    type: 'boolean',    description: 'Disable cache usage',    default: false,  })  .option('type', {    alias: 't',    type: 'string',    choices: ['revenue', 'eps', 'both'],    default: 'both',    description: 'Type of growth data to fetch',  })  .help()  .parseSync();async function main(): Promise<void> {  // è¨­ç½®ä¿¡è™Ÿè™•ç†  const signalHandler = setupCliSignalHandler('æŠ“å–æˆé•·è³‡æ–™');  try {    await ErrorHandler.initialize();    const initSpinner = ora('ğŸš€ é–‹å§‹æŠ“å–æˆé•·è³‡æ–™...').start();    const fetcher = new GrowthFetcher();    await fetcher.initialize();        // æ·»åŠ æ¸…ç†å‡½æ•¸    signalHandler.addCleanupFunction(async () => {      await fetcher.close();    });        initSpinner.succeed('åˆå§‹åŒ–å®Œæˆ');    const stockList = argv.stocks      ? argv.stocks.split(',').map((s: string) => s.trim())      : DEFAULT_STOCK_CODES;    console.log(`ğŸ“Š å°‡æŠ“å– ${stockList.length} æ”¯è‚¡ç¥¨çš„æˆé•·è³‡æ–™`);    let totalSuccessful = 0;    let totalFailed = 0;    if (argv.type === 'revenue' || argv.type === 'both') {      console.log('\nğŸ“ˆ é–‹å§‹æŠ“å–ç‡Ÿæ”¶è³‡æ–™...');            const result = await processStocks(stockList, async (stockCode: string) => {        return await fetcher.fetchRevenueData({          stockNos: [stockCode],          useCache: !argv['no-cache'],        });      }, {        progressPrefix: 'æŠ“å–ç‡Ÿæ”¶è³‡æ–™',        concurrency: 5,        maxRetries: 2,        skipOnError: true,        onError: (stockCode, error) => {          if (error.message.includes('402 Payment Required')) {            console.log(`âš ï¸  ${stockCode} - FinMind API é…é¡ä¸è¶³ï¼Œè·³éæ­¤è‚¡ç¥¨`);          } else {            console.log(`âŒ ${stockCode} ç‡Ÿæ”¶è³‡æ–™æŠ“å–å¤±æ•—: ${error.message}`);          }        }      });      totalSuccessful += result.successful.length;      totalFailed += result.failed.length;      console.log(`ğŸ“Š ç‡Ÿæ”¶è³‡æ–™æŠ“å–çµæœ: æˆåŠŸ ${result.successful.length}, å¤±æ•— ${result.failed.length}`);    }    if (argv.type === 'eps' || argv.type === 'both') {      console.log('\nğŸ’° é–‹å§‹æŠ“å– EPS è³‡æ–™...');            const result = await processStocks(stockList, async (stockCode: string) => {        return await fetcher.fetchEpsData({          stockNos: [stockCode],          useCache: !argv['no-cache'],        });      }, {        progressPrefix: 'æŠ“å– EPS è³‡æ–™',        concurrency: 5,        maxRetries: 2,        skipOnError: true,        onError: (stockCode, error) => {          if (error.message.includes('402 Payment Required')) {            console.log(`âš ï¸  ${stockCode} - FinMind API é…é¡ä¸è¶³ï¼Œè·³éæ­¤è‚¡ç¥¨`);          } else {            console.log(`âŒ ${stockCode} EPS è³‡æ–™æŠ“å–å¤±æ•—: ${error.message}`);          }        }      });      totalSuccessful += result.successful.length;      totalFailed += result.failed.length;      console.log(`ğŸ“Š EPS è³‡æ–™æŠ“å–çµæœ: æˆåŠŸ ${result.successful.length}, å¤±æ•— ${result.failed.length}`);    }    await fetcher.close();    console.log(`\nâœ… æˆé•·è³‡æ–™æŠ“å–å®Œæˆ - ç¸½è¨ˆæˆåŠŸ: ${totalSuccessful}, å¤±æ•—: ${totalFailed}`);  } catch (error) {    await ErrorHandler.logError(error as Error, 'fetch-growth');        if ((error as Error).message.includes('402 Payment Required')) {      console.error('âš ï¸  FinMind API é…é¡ä¸è¶³ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è€ƒæ…®å‡ç´šæ–¹æ¡ˆ');    } else {      console.error('âŒ éŒ¯èª¤:', (error as Error).message);    }    process.exit(1);  }}if (import.meta.url === `file://${process.argv[1]}`) {  main();}