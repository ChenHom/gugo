# FinMind API 額度限制解決方案

## 🔥 問題描述

當前 CLI 執行過程中遭遇 FinMind API 的 `402 Payment Required` 錯誤，表示免費額度已用完。

## 🛠️ 立即解決方案

### 1. 停止目前的 CLI 執行
目前正在執行的 `npm run fetch-all` 已在抓取到約 370 支股票時因 FinMind 額度限制而開始失敗。建議立即停止以避免浪費資源。

### 2. 實作的解決方案

已在程式碼中實作以下改進：

#### A. 改善錯誤訊息 (`finmindClient.ts`)
- ✅ 對 402 錯誤提供清楚的付費提示
- ✅ 建議使用者申請付費方案或等待明天額度重置

#### B. 創建 TWSE API 客戶端 (`twseApiClient.ts`)
- ✅ 實作台灣證券交易所 OpenAPI 的直接對接
- ✅ 支援三大法人買賣超、月營收、估值資料
- ✅ 包含資料格式轉換功能

#### C. 建立 Fallback 機制 (`fundFlowFetcher.ts`)
- ✅ 優先使用 TWSE OpenAPI
- ✅ 在 FinMind 402 錯誤時自動回退到 TWSE
- ✅ 改善錯誤處理和用戶提示

### 3. 建議的執行策略

#### 立即執行方案：
```bash
# 停止目前執行
Ctrl+C

# 等待明天 FinMind 額度重置後再試
# 或申請 FinMind 付費方案
```

#### 中長期方案：
1. **申請 FinMind 付費方案**
   - 訪問 https://finmind.github.io/
   - 取得 API Token
   - 設定環境變數: `FINMIND_TOKEN=your_token_here`

2. **啟用 TWSE Fallback** (已實作但需進一步整合)
   - 對於資金流向資料：已實作 TWSE 備用方案
   - 對於月營收資料：需要進一步實作 TWSE 端點整合
   - 對於財務報表：建議使用 TWSE `/v1/opendata/t187ap05_L`

### 4. 可用的 TWSE OpenAPI 端點

| 資料類型 | TWSE 端點 | 狀態 |
|---------|----------|------|
| 估值資料 | `/v1/exchangeReport/BWIBBU_d` | ✅ 可用 |
| 三大法人 | `/fund/TWT38U` | ✅ 已實作 |
| 月營收 | `/v1/opendata/t187ap03_L` | ⚠️ 需實作 |
| 財務報表 | `/v1/opendata/t187ap05_L` | ⚠️ 需實作 |

## 🎯 下一步行動

1. **立即停止** 目前的 CLI 執行
2. **決定策略**：
   - 等待明天額度重置（免費但受限）
   - 申請 FinMind 付費方案（建議）
3. **如果選擇等待**：明天重新執行時將有改善的錯誤處理
4. **如果選擇付費方案**：設定 Token 後可立即重新執行

## 📈 預期改善效果

- ✅ 更友善的錯誤訊息
- ✅ 自動回退機制（部分實作）
- ✅ 減少因額度限制造成的中斷
- 🔄 未來可完全不依賴 FinMind（需進一步開發）

## 💡 建議

**最佳解決方案**：申請 FinMind 付費方案，因為：
1. 資料品質和完整性較佳
2. API 穩定性高
3. 支援更多資料類型
4. 已有完整的錯誤處理機制

**備用方案**：等待免費額度重置，明天再試。
